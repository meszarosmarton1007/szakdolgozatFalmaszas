@model ClimbingApplication.Models.Utak

@{
    ViewData["Title"] = "Edit";
}

<head>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.0/fabric.min.js"></script>
</head>

<h1>Edit</h1>

<h4>Utak</h4>
<hr />
<div class="row">
    <div class="col-md-4">
        <select id="colorPicker">
            <option value="red">Piros</option>
            <option value="blue">Kék</option>
            <option value="green">Zöld</option>
            <option value="black">Fekete</option>
            <option value="white">Fehér</option>
            <option value="yellow">Sárga</option>
            <option value="orange">Narancssárga</option>
        </select>
        <button onclick="undo()">Visszavonás</button>
        <button onclick="redo()">Visszaállítás</button>
        <button onclick="saveImage()">Mentés</button>
        <br />
    <div class="col-md-4">
        <form asp-action="Edit">
            <div asp-validation-summary="ModelOnly" class="text-danger"></div>
            <input type="hidden" asp-for="ID" />
            <div class="form-group">
                <label asp-for="kep" class="control-label"></label>
                <input asp-for="kep" class="form-control" />
                <span asp-validation-for="kep" class="text-danger"></span>
                    <input type="file" id="imageLoader" accept="image/*" />
                    <canvas id="canvas" width="800" height="600"></canvas>

                    <script>
                        const canvas = new fabric.Canvas('canvas');
                        let drawing = false;

                        // Undo / Redo stack
                        let stateStack = [];
                        let redoStack = [];
                        let isRestoringState = false;

                        function saveState() {
                            if (isRestoringState) return;
                            const json = canvas.toJSON();
                            stateStack.push(json);
                            // új művelet történt, redo stack törlődik
                            redoStack = [];
                        }

                        // Állapot visszatöltés
                        function loadState(state) {
                            isRestoringState = true;
                            canvas.loadFromJSON(state, () => {
                                canvas.renderAll();
                                isRestoringState = false;
                            });
                        }

                        function undo() {
                            if (stateStack.length > 1) {
                                redoStack.push(stateStack.pop());
                                const previousState = stateStack[stateStack.length - 1];
                                loadState(previousState);
                            }
                        }

                        function redo() {
                            if (redoStack.length > 0) {
                                const nextState = redoStack.pop();
                                stateStack.push(nextState);
                                loadState(nextState);
                            }
                        }
                        //Kép betöltése
                        document.getElementById('imageLoader').addEventListener('change', function (e) {
                            const reader = new FileReader();
                            reader.onload = function (event) {
                                fabric.Image.fromURL(event.target.result, function (img) {
                                    canvas.clear();
                                    canvas.setBackgroundImage(img, canvas.renderAll.bind(canvas), {
                                        scaleX: canvas.width / img.width,
                                        scaleY: canvas.height / img.height
                                    });

                                    // új háttér betöltés = új állapot
                                    saveState();
                                });
                            };
                            reader.readAsDataURL(e.target.files[0]);
                        });

                        canvas.on('path:created', function () {
                            saveState();
                        });

                        // Kezdő állapot mentése
                        saveState();



                        // Betöltött kép hozzáadása
                        document.getElementById('imageLoader').addEventListener('change', function (e) {
                            const reader = new FileReader();
                            reader.onload = function (event) {
                                fabric.Image.fromURL(event.target.result, function (img) {
                                    canvas.clear();
                                    canvas.setBackgroundImage(img, canvas.renderAll.bind(canvas), {
                                        scaleX: canvas.width / img.width,
                                        scaleY: canvas.height / img.height
                                    });
                                });
                            };
                            reader.readAsDataURL(e.target.files[0]);
                        });

                        // Szín kiválasztása
                        let currentColor = 'red';
                        document.getElementById('colorPicker').addEventListener('change', function (e) {
                            currentColor = e.target.value;
                            canvas.freeDrawingBrush.color = currentColor;
                        });

                        // Rajzolás bekapcsolása
                        canvas.isDrawingMode = true;
                        canvas.freeDrawingBrush = new fabric.PencilBrush(canvas);
                        canvas.freeDrawingBrush.width = 5;
                        canvas.freeDrawingBrush.color = currentColor;

                        // Kép mentése
                        function saveImage() {
                            const dataURL = canvas.toDataURL({
                                format: 'png'
                            });

                            fetch('/api/saveimage', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ imageData: dataURL })
                            }).then(res => {
                                if (res.ok) {
                                    alert('Kép mentve!');
                                } else {
                                    alert('Hiba történt a mentés során.');
                                }
                            });
                        }
                    </script>
            </div>
            <div class="form-group">
                <label asp-for="nehezseg" class="control-label"></label>
                <input asp-for="nehezseg" class="form-control" />
                <span asp-validation-for="nehezseg" class="text-danger"></span>
            </div>
            <div class="form-group">
                <label asp-for="nev" class="control-label"></label>
                <input asp-for="nev" class="form-control" />
                <span asp-validation-for="nev" class="text-danger"></span>
            </div>
            <div class="form-group">
                <label asp-for="leiras" class="control-label"></label>
                <textarea asp-for="leiras" class="form-control" ></textarea>
                <span asp-validation-for="leiras" class="text-danger"></span>
            </div>
            <div class="form-group">
                <label asp-for="letrehozva" class="control-label"></label>
                <input asp-for="letrehozva" class="form-control" type="date"/>
                <span asp-validation-for="letrehozva" class="text-danger"></span>
            </div>
            <div class="form-group">
               <label>Falon van</label>
               <input class="form-control" value="@Model.Falonut?.nev" disabled />
            </div>
                <div class="form-group">
                    <label>Létrehozó</label>
                    <input class="form-control" value="@Model.UtLetrehozo?.felhasznaloNev" disabled />
                </div>
            <div class="form-group">
                <input type="submit" value="Save" class="btn btn-primary" />
            </div>
        </form>
    </div>
</div>

<div>
        <a href="@Url.Action("Utak", "Falak", new { id = ViewBag.FalId })">Back to List</a>
</div>

@section Scripts {
    @{await Html.RenderPartialAsync("_ValidationScriptsPartial");}
}
